###############################################################################
# Tetragon TracingPolicy — 5.9 Nginx ab
#
# 주요 syscall 및 커널 함수를 kprobe로 트레이싱.
# 컨테이너 프로세스만 대상 (호스트 Mnt/Pid 네임스페이스 제외).
#
# 카테고리:
#   1) 프로세스: execve, execveat, exit_group, security_bprm_check, do_exit
#   2) 파일: open, openat, openat2, close, security_file_open
#   3) 네트워크: connect, inet_bind, inet_stream_connect, inet_csk_accept,
#               udp_sendmsg, udp_recvmsg
#
# 적용: kubectl apply -f tetragon-policy.yaml
# 제거: kubectl delete -f tetragon-policy.yaml
###############################################################################

# ── 프로세스 ─────────────────────────────────────────────────────────
apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: bench-nginx-ab-process
spec:
  kprobes:
    - call: "__x64_sys_execve"
      syscall: true
      args:
        - index: 0
          type: "string"
      selectors:
        - matchNamespaces:
            - namespace: Mnt
              operator: NotIn
              values: ["host_ns"]
            - namespace: Pid
              operator: NotIn
              values: ["host_ns"]
    - call: "__x64_sys_execveat"
      syscall: true
      args:
        - index: 1
          type: "string"
      selectors:
        - matchNamespaces:
            - namespace: Mnt
              operator: NotIn
              values: ["host_ns"]
            - namespace: Pid
              operator: NotIn
              values: ["host_ns"]
    - call: "__x64_sys_exit_group"
      syscall: true
      selectors:
        - matchNamespaces:
            - namespace: Mnt
              operator: NotIn
              values: ["host_ns"]
            - namespace: Pid
              operator: NotIn
              values: ["host_ns"]
    - call: "security_bprm_check"
      syscall: false
      selectors:
        - matchNamespaces:
            - namespace: Mnt
              operator: NotIn
              values: ["host_ns"]
            - namespace: Pid
              operator: NotIn
              values: ["host_ns"]
    - call: "do_exit"
      syscall: false
      args:
        - index: 0
          type: "int64"
      selectors:
        - matchNamespaces:
            - namespace: Mnt
              operator: NotIn
              values: ["host_ns"]
            - namespace: Pid
              operator: NotIn
              values: ["host_ns"]
---
# ── 파일 ─────────────────────────────────────────────────────────────
apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: bench-nginx-ab-file
spec:
  kprobes:
    - call: "__x64_sys_openat"
      syscall: true
      args:
        - index: 1
          type: "string"
      selectors:
        - matchNamespaces:
            - namespace: Mnt
              operator: NotIn
              values: ["host_ns"]
            - namespace: Pid
              operator: NotIn
              values: ["host_ns"]
    - call: "__x64_sys_openat2"
      syscall: true
      args:
        - index: 1
          type: "string"
      selectors:
        - matchNamespaces:
            - namespace: Mnt
              operator: NotIn
              values: ["host_ns"]
            - namespace: Pid
              operator: NotIn
              values: ["host_ns"]
    - call: "__x64_sys_close"
      syscall: true
      selectors:
        - matchNamespaces:
            - namespace: Mnt
              operator: NotIn
              values: ["host_ns"]
            - namespace: Pid
              operator: NotIn
              values: ["host_ns"]
    - call: "security_file_open"
      syscall: false
      args:
        - index: 0
          type: "file"
      selectors:
        - matchNamespaces:
            - namespace: Mnt
              operator: NotIn
              values: ["host_ns"]
            - namespace: Pid
              operator: NotIn
              values: ["host_ns"]
---
# ── 네트워크 ─────────────────────────────────────────────────────────
apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: bench-nginx-ab-network
spec:
  kprobes:
    - call: "__x64_sys_connect"
      syscall: true
      args:
        - index: 1
          type: "sockaddr"
      selectors:
        - matchNamespaces:
            - namespace: Mnt
              operator: NotIn
              values: ["host_ns"]
            - namespace: Pid
              operator: NotIn
              values: ["host_ns"]
    - call: "inet_bind"
      syscall: false
      selectors:
        - matchNamespaces:
            - namespace: Mnt
              operator: NotIn
              values: ["host_ns"]
            - namespace: Pid
              operator: NotIn
              values: ["host_ns"]
    - call: "inet_stream_connect"
      syscall: false
      selectors:
        - matchNamespaces:
            - namespace: Mnt
              operator: NotIn
              values: ["host_ns"]
            - namespace: Pid
              operator: NotIn
              values: ["host_ns"]
    - call: "inet_csk_accept"
      syscall: false
      return: true
      args:
        - index: 0
          type: "sock"
      returnArg:
        index: 0
        type: "sock"
      selectors:
        - matchNamespaces:
            - namespace: Mnt
              operator: NotIn
              values: ["host_ns"]
            - namespace: Pid
              operator: NotIn
              values: ["host_ns"]
    - call: "udp_sendmsg"
      syscall: false
      args:
        - index: 0
          type: "sock"
      selectors:
        - matchNamespaces:
            - namespace: Mnt
              operator: NotIn
              values: ["host_ns"]
            - namespace: Pid
              operator: NotIn
              values: ["host_ns"]
    - call: "udp_recvmsg"
      syscall: false
      args:
        - index: 0
          type: "sock"
      selectors:
        - matchNamespaces:
            - namespace: Mnt
              operator: NotIn
              values: ["host_ns"]
            - namespace: Pid
              operator: NotIn
              values: ["host_ns"]
