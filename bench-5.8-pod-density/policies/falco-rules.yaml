###############################################################################
# Falco Rules — 5.8 Pod Density
#
# 밀도 Pod에 대한 일반적인 보안 모니터링 규칙.
# Pod 수 증가에 따른 Falco의 CPU/Memory 오버헤드를 측정.
# KloudKnox/Tetragon과 동일한 3개 카테고리로 공정한 비교.
#
# 카테고리:
#   1) 프로세스: execve/execveat
#   2) 파일: open/openat (sensitive paths)
#   3) 네트워크: connect (outbound) + accept/accept4 (inbound)
#
# 적용:
#   helm upgrade falco falcosecurity/falco -n falco --reuse-values \
#       --set-file "customRules.bench-rules\.yaml=falco-rules.yaml"
###############################################################################
- rule: Bench Density Process Execution
  desc: Audit process execution in density pods
  condition: >
    evt.type in (execve, execveat)
    and container.id != host
  output: >
    Process executed in density pod
    (user=%user.name command=%proc.cmdline exe=%proc.exepath
     parent=%proc.pname container=%container.name
     ns=%k8s.ns.name pod=%k8s.pod.name)
  priority: NOTICE
  tags: [bench, pod-density]

- rule: Bench Density Sensitive File Access
  desc: Audit access to sensitive files in density pods
  condition: >
    evt.type in (open, openat, openat2)
    and container.id != host
    and (fd.name startswith /etc/ or fd.name startswith /proc/ or fd.name startswith /sys/)
  output: >
    Sensitive file access in density pod
    (user=%user.name file=%fd.name dir=%fd.directory exe=%proc.exepath
     command=%proc.cmdline container=%container.name
     ns=%k8s.ns.name pod=%k8s.pod.name)
  priority: NOTICE
  tags: [bench, pod-density]

- rule: Bench Density Outbound Connection
  desc: Audit outbound network connections from density pods
  condition: >
    evt.type = connect
    and container.id != host
    and fd.type = ipv4
  output: >
    Network connect from density pod
    (user=%user.name command=%proc.cmdline exe=%proc.exepath
     dest=%fd.sip:%fd.sport container=%container.name
     ns=%k8s.ns.name pod=%k8s.pod.name)
  priority: NOTICE
  tags: [bench, pod-density]

- rule: Bench Density Inbound Connection
  desc: Audit inbound network connections to density pods
  condition: >
    evt.type in (accept, accept4)
    and container.id != host
  output: >
    Network accept in density pod
    (user=%user.name command=%proc.cmdline exe=%proc.exepath
     client=%fd.cip:%fd.cport container=%container.name
     ns=%k8s.ns.name pod=%k8s.pod.name)
  priority: NOTICE
  tags: [bench, pod-density]
