###############################################################################
# Falco Rules — 5.8 Pod Density
#
# 5.5 (syscall) + 5.6 (nginx) Falco rules 합본.
# container.id != host 조건은 공통이므로 중복 제거.
# namespace 필터를 bench-density로 통일.
#
# 카테고리:
#   1) 네트워크: accept/accept4 (inbound) + connect (outbound)
#   2) 프로세스: execve/execveat
#   3) 파일: open/openat/openat2
#
# 적용:
#   helm upgrade falco falcosecurity/falco -n falco --reuse-values \
#       --set-file "customRules.bench-rules\.yaml=falco-rules.yaml"
###############################################################################
- rule: Bench Density Inbound Connection
  desc: Audit inbound connections to Nginx containers in bench-density
  condition: >
    evt.type in (accept, accept4)
    and container.id != host
    and fd.sport = 80
    and k8s.ns.name = bench-density
  output: >
    Nginx inbound connection
    (client=%fd.cip:%fd.cport server=%fd.sip:%fd.sport
     exe=%proc.exepath command=%proc.cmdline
     container=%container.name ns=%k8s.ns.name pod=%k8s.pod.name)
  priority: NOTICE
  tags: [bench, density]

- rule: Bench Density Outbound Connection
  desc: Audit outbound connections from containers in bench-density
  condition: >
    evt.type = connect
    and container.id != host
    and k8s.ns.name = bench-density
    and fd.type = ipv4
  output: >
    Network connect
    (user=%user.name command=%proc.cmdline exe=%proc.exepath
     dest=%fd.sip:%fd.sport container=%container.name
     ns=%k8s.ns.name pod=%k8s.pod.name)
  priority: NOTICE
  tags: [bench, density]

- rule: Bench Density Process Audit
  desc: Audit process executions in containers in bench-density
  condition: >
    evt.type in (execve, execveat)
    and container.id != host
    and k8s.ns.name = bench-density
  output: >
    Process executed
    (user=%user.name command=%proc.cmdline exe=%proc.exepath
     parent=%proc.pname container=%container.name
     ns=%k8s.ns.name pod=%k8s.pod.name)
  priority: NOTICE
  tags: [bench, density]

- rule: Bench Density File Access
  desc: Audit file access in containers in bench-density
  condition: >
    evt.type in (open, openat, openat2)
    and container.id != host
    and k8s.ns.name = bench-density
  output: >
    File access
    (user=%user.name file=%fd.name dir=%fd.directory exe=%proc.exepath
     command=%proc.cmdline container=%container.name
     ns=%k8s.ns.name pod=%k8s.pod.name)
  priority: NOTICE
  tags: [bench, density]
